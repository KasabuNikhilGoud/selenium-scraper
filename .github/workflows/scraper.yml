name: Daily Selenium Scraper

on:
  schedule:
    - cron: "30 1 * * *"   # Runs daily at 07:00 AM IST (01:30 UTC)
  workflow_dispatch:        # Allows manual run from Actions tab

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
      # âœ… Step 1: Checkout your repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # âœ… Step 2: Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # âœ… Step 3: Install Python dependencies + Chrome for Selenium
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      # âœ… Step 4: Create Google Sheets credentials file
      - name: Create Google credentials file
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json

      # âœ… Step 5: Run the Selenium scraper
      - name: Run scraper
        run: python attendence_V4.py

      # âœ… Step 6: Send email notification (always runs, even on failure)
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âœ… Selenium Scraper Finished (Status: ${{ job.status }})"
          to: kasabunikil@gmail.com
          from: "GitHub Actions Bot <${{ secrets.MAIL_USERNAME }}>"
          content_type: text/html      # âœ… Force HTML format
          body: |
            <!DOCTYPE html>
<html lang="en">
  <body style="margin:0; padding:0; background-color:#f5f8fa; font-family:Arial,sans-serif; font-size:12px;">

    <!-- Container Table -->
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color:#f5f8fa;">
      <tr>
        <td align="center">

          <!-- Card Container -->
          <table width="400" cellpadding="0" cellspacing="0" style="background:#ffffff; border:1px solid #e6ecf0; border-radius:14px; overflow:hidden;">

            <!-- Header Image -->
            <tr>
              <td>
                <img src="https://images.unsplash.com/photo-1557989048-03456d01a26e?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzB8fGNsYXNzJTIwYXR0ZW5kZW5jZSUyMHJlcG9ydHxlbnwwfHwwfHx8MA%3D%3D" alt="Attendance" width="400" height="70" style="display:block; object-fit:cover; border-bottom:1px solid #e6ecf0; border-radius:14px 14px 0 0;">
              </td>
            </tr>

            <!-- Report Header -->
            <tr>
              <td align="center" style="background:#f9fbfc; padding:8px; border-bottom:1px solid #e6ecf0;">
                <h2 style="margin:0; font-size:14px; font-weight:bold; color:#14171a;">âœ… Daily Attendance Scraper Report</h2>
                <p style="margin:2px 0; font-size:11px; color:#657786;">${{ github.event_name }} | Run #${{ github.run_number }}</p>
              </td>
            </tr>

            <!-- Content Section -->
            <tr>
              <td style="padding:10px 12px; color:#14171a; font-size:12px; line-height:1.5;">
                <strong>Hello Nikki ğŸ‘‹,</strong><br>
                The Selenium scraper has finished running.
                
                <!-- Status Box -->
                <table width="100%" cellpadding="8" cellspacing="0" style="margin:10px 0; background:#f1f8ff; border-left:3px solid #1da1f2; border-radius:8px;">
                  <tr>
                    <td style="font-size:12px; color:#14171a;">
                      ğŸ“Œ <strong>Status:</strong> <b>${{ job.status }}</b><br>
                      â° <strong>Run Time:</strong> ${{ github.run_started_at }}
                    </td>
                  </tr>
                </table>

                ğŸ“„ Click below to view:
              </td>
            </tr>

            <!-- Buttons Section -->
            <tr>
              <td align="center" style="padding:10px;">
                
                <!-- Open Sheet -->
                <a href="https://docs.google.com/spreadsheets/d/13ZP7Q9-Yc4mFM64zGosg0CZYWtwWq2RlL9piU2B7qeY/edit?gid=728086314#gid=728086314"
                   style="display:inline-block; background-color:#657786; color:#ffffff; text-decoration:none; font-size:12px; font-weight:bold; padding:6px 60px; margin:6px; border-radius:20px;">
                   ğŸ“– Open Sheet
                </a>
                <br>
                
                <!-- View Logs -->
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                   style="display:inline-block; background-color:red; color:#ffffff; text-decoration:none; font-size:12px; font-weight:bold; padding:6px 66px; margin:6px; border-radius:20px;">
                   ğŸ“œ View Logs
                </a>
                <br>

                <!-- Retry Workflow -->
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/workflows/scraper.yml?browser=1"
                   style="display:inline-block; background-color:#1da1f2; color:#ffffff; text-decoration:none; font-size:12px; font-weight:bold; padding:6px 50px; margin:6px; border-radius:20px;">
                   ğŸ”„ Retry Workflow
                </a>

              </td>
            </tr>

            <!-- Message -->
            <tr>
              <td style="padding:0 12px 10px; color:#14171a; font-size:12px; line-height:1.5;">
                Keep track easily! ğŸš€<br>
                Cheers,<br>
                Automation Bot ğŸ¤–
              </td>
            </tr>

            <!-- Footer -->
            <tr>
              <td align="center" style="padding:6px; font-size:11px; color:#657786; border-top:1px solid #e6ecf0;">
                Auto Email | GitHub Actions
              </td>
            </tr>

          </table>
        </td>
      </tr>
    </table>

  </body>
</html>
