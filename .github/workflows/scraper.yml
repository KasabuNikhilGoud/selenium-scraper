name: Daily Selenium Scraper

on:
  schedule:
    - cron: "0 9 * * *"   # âœ… Runs daily at 2:30 PM IST (09:00 UTC)
  workflow_dispatch:        # âœ… Allows manual trigger from Actions tab

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
      # âœ… Step 1: Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # âœ… Step 2: Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # âœ… Step 3: Install Chromium & ChromeDriver for Selenium
      - name: Install Chromium & ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
          echo "Chromium path: $(which chromium-browser)"
          echo "ChromeDriver path: $(which chromedriver)"

      # âœ… Step 4: Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # âœ… Step 5: Create Google Sheets credentials
      - name: Create Google credentials file
        run: echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json

      # âœ… Step 6: Show current UTC & IST times
      - name: Show current time
        id: runtime
        run: |
          echo "âœ… UTC time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          export TZ=Asia/Kolkata
          echo "âœ… IST time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "now=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      # âœ… Step 7: Run the Selenium scraper
      - name: Run Selenium scraper
        run: python attendence_V4.py

      # âœ… Step 8: Send Email Notification (always runs)
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Daily Selenium Scraper - Status: ${{ job.status }}"
          to: kasabunikil@gmail.com
          from: "GitHub Actions Bot <${{ secrets.MAIL_USERNAME }}>"
          html_body: |
            <!DOCTYPE html>
            <html>
            <body style="font-family: Arial, sans-serif; font-size: 14px; color: #333;">
              <h2>âœ… Daily Attendance Scraper Report</h2>
              <p>ðŸ“… <b>Date/Time (IST):</b> ${{ steps.runtime.outputs.now }}</p>
              <p>ðŸ“Œ <b>Status:</b> <b>${{ job.status }}</b></p>
              <p>ðŸ“„ <b>Google Sheet:</b> 
                <a href="https://docs.google.com/spreadsheets/d/13ZP7Q9-Yc4mFM64zGosg0CZYWtwWq2RlL9piU2B7qeY/edit?gid=728086314#gid=728086314">
                  Open Attendance Sheet
                </a>
              </p>
              <p>ðŸ“œ <b>Logs:</b> 
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                  View Full Logs
                </a>
              </p>
              <p>ðŸ”„ <b>Retry:</b> 
                <a href="${{ github.server_url }}/${{ github.repository }}/actions">
                  Run Workflow Again
                </a>
              </p>
              <hr>
              <small>Automated Email via GitHub Actions ðŸ¤–</small>
            </body>
            </html>
